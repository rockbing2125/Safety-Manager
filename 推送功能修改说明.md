# 推送功能修改说明

## 修改概述

为实现"用户在另一台电脑重新打开程序自动收到推送通知"的需求，对系统进行了以下改进。

## 代码修改

### 1. 修复数据库配置 (.env)

**问题**：原配置缺少数据库文件名，导致无法连接
```ini
# 修改前（错误）
DATABASE_PATH=\\10.0.104.252\SafetyManager

# 修改后（正确）
DATABASE_PATH=\\10.0.104.252\SafetyManager\regulations.db
```

**位置**：`.env` 文件第2行

---

### 2. 增强主窗口 (client/ui/main_window.py)

#### 修改点1：添加通知计数器（第66行）
```python
# 添加
self.last_notification_count = None  # 记录上次通知数量，None表示首次检查
```

**作用**：追踪通知数量变化，用于判断是否需要弹窗提醒

#### 修改点2：增强检测逻辑（第277-296行）
```python
def check_for_updates(self):
    """检查更新并更新小红点"""
    unread_count = self.update_service.get_unread_count()
    self.update_button.set_badge_count(unread_count)

    # 如果有新的通知，自动弹窗提醒
    # 1. 首次检查（last_notification_count为None）且有未读通知
    # 2. 非首次检查且通知数量增加
    should_alert = False
    if self.last_notification_count is None:
        # 首次检查，如果有未读通知就提醒
        should_alert = unread_count > 0
    else:
        # 非首次检查，只有数量增加时才提醒
        should_alert = unread_count > self.last_notification_count

    if should_alert:
        self.show_notification_alert(unread_count)

    self.last_notification_count = unread_count
```

**作用**：
- 首次打开程序时，如果有未读通知，自动弹窗提醒
- 程序运行期间，如果检测到新通知，自动弹窗提醒

#### 修改点3：添加弹窗提醒方法（第298-295行）
```python
def show_notification_alert(self, count: int):
    """显示新通知提醒"""
    reply = QMessageBox.information(
        self,
        "新消息提醒",
        f"您有 {count} 条未读通知\n\n点击【版本更新】按钮查看详情",
        QMessageBox.StandardButton.Ok
    )
```

**作用**：显示提醒对话框，通知用户有新消息

---

## 新增文件

### 1. 推送功能使用说明.md
- 完整的功能说明文档
- 配置步骤详解
- 常见问题解答
- 技术实现说明

### 2. 推送功能快速开始.txt
- 快速开始指南
- 配置步骤简化版
- 快速排查问题

### 3. 测试推送功能.bat
- 自动化测试脚本
- 检查数据库配置
- 验证连接状态
- 显示通知统计

### 4. 推送功能修改说明.md（本文件）
- 修改内容总结
- 代码变更说明

---

## 功能特性

### 自动检测机制
✅ **启动检查**：程序启动时立即检查一次
✅ **定时检查**：每5分钟自动检查一次
✅ **智能提醒**：有新通知自动弹窗

### 提醒触发条件
1. **首次打开**：如果有未读通知 → 立即弹窗
2. **运行期间**：检测到通知数量增加 → 立即弹窗

### 界面提示
- **小红点**：显示未读通知数量
- **弹窗提醒**：主动通知用户
- **通知列表**：查看详细内容

---

## 使用流程

### 第一步：配置共享数据库

所有电脑必须访问同一个数据库文件。

**方法1：使用配置工具（推荐）**
```
双击运行：配置共享数据库.bat
输入路径：\\10.0.104.252\SafetyManager\regulations.db
```

**方法2：手动编辑 .env**
```ini
DATABASE_PATH=\\10.0.104.252\SafetyManager\regulations.db
```

### 第二步：验证配置

```
双击运行：测试推送功能.bat
```

看到"测试完成"说明配置正确。

### 第三步：使用推送功能

**管理员推送：**
1. 点击工具栏【推送更新】
2. 填写通知信息
3. 点击【推送通知】

**用户接收：**
- 打开程序自动收到提醒
- 点击【版本更新】查看详情

---

## 技术实现

### 检测流程图

```
程序启动
  ↓
初始化 (last_notification_count = None)
  ↓
首次检查 check_for_updates()
  ↓
获取未读数量
  ↓
判断：是首次检查吗？
  ├─ 是 → 有未读通知？→ 是 → 弹窗提醒
  └─ 否 → 数量增加？→ 是 → 弹窗提醒
  ↓
更新 last_notification_count
  ↓
启动定时器（5分钟）
  ↓
定期检查（重复上述流程）
```

### 数据流

```
管理员推送
  ↓
写入数据库 (update_notifications 表)
  ↓
其他电脑的程序检测
  ↓
发现未读通知
  ↓
弹窗提醒用户
```

---

## 测试验证

### 测试场景1：首次打开有未读通知

**步骤：**
1. 管理员推送一条通知
2. 另一台电脑打开程序

**预期：**
- 程序启动后立即弹出提醒
- 【版本更新】按钮显示红色数字

**实际：**
✅ 通过

---

### 测试场景2：程序运行时收到新通知

**步骤：**
1. 打开程序
2. 等待5分钟以上
3. 管理员在另一台电脑推送通知

**预期：**
- 5分钟内自动弹出提醒
- 红色数字增加

**实际：**
需要验证（依赖定时器）

---

### 测试场景3：配置错误的处理

**步骤：**
1. 配置错误的数据库路径
2. 运行测试脚本

**预期：**
- 显示"数据库连接失败"
- 给出解决建议

**实际：**
✅ 通过

---

## 注意事项

### 配置要求
⚠️ **必须包含文件名**：`\\服务器\路径\regulations.db`
⚠️ **路径使用双反斜杠**：`\\` 而不是 `\`
⚠️ **所有电脑配置一致**：确保访问同一数据库

### 权限要求
- 共享文件夹需要读写权限
- 数据库文件需要可修改

### 网络要求
- 所有电脑能访问共享文件夹
- 网络连接稳定

---

## 已知限制

1. **已读状态全局共享**
   - 任何用户标记已读，所有用户都会看到
   - 未来可改进为每用户独立状态

2. **检查间隔固定**
   - 当前固定为5分钟
   - 未来可添加配置选项

3. **弹窗无法关闭**
   - 自动弹窗是内置功能
   - 未来可添加配置开关

---

## 文件清单

### 修改的文件
- `.env` - 修复数据库路径配置
- `client/ui/main_window.py` - 添加自动提醒功能

### 新增的文件
- `推送功能使用说明.md` - 详细文档
- `推送功能快速开始.txt` - 快速指南
- `测试推送功能.bat` - 测试工具
- `推送功能修改说明.md` - 本文件

### 相关的文件
- `client/services/update_service.py` - 通知服务（已存在）
- `client/models/update_notification.py` - 数据模型（已存在）
- `client/ui/push_update_dialog.py` - 推送对话框（已存在）
- `client/ui/update_notifications_dialog.py` - 通知列表（已存在）
- `配置共享数据库.bat` - 配置工具（已存在）
- `测试数据库连接.bat` - 连接测试（已存在）

---

## 兼容性

- ✅ Windows 10/11
- ✅ Python 3.8+
- ✅ PyQt6
- ✅ SQLite 数据库
- ✅ 网络共享文件夹（SMB）

---

## 后续改进建议

### 短期改进
- [ ] 添加通知音效
- [ ] 支持系统托盘通知
- [ ] 自定义检查间隔

### 中期改进
- [ ] 每用户独立的已读状态
- [ ] 通知优先级（普通/重要/紧急）
- [ ] 通知分类和过滤

### 长期改进
- [ ] 推送历史统计
- [ ] 邮件通知功能
- [ ] 移动端推送
- [ ] WebSocket 实时推送

---

## 版本历史

### v1.1.0 (2025-12-02)
- ✨ 新增：自动推送通知功能
- 🐛 修复：数据库配置路径问题
- 📝 新增：完整的使用文档
- 🔧 新增：测试工具脚本

---

## 联系支持

如遇问题，请：
1. 查看《推送功能使用说明.md》
2. 运行《测试推送功能.bat》诊断
3. 检查《推送功能快速开始.txt》
