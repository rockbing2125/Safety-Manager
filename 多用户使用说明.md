# 多用户使用和推送更新说明

## 当前问题

**推送更新无法被其他电脑接收**

### 原因分析

系统目前是**离线模式**运行，每台电脑都使用**独立的本地数据库**：
- 电脑A的数据库：`D:\work_file\AI\Safety-Manager\data\databases\regulations.db`
- 电脑B的数据库：`C:\用户\张三\Safety-Manager\data\databases\regulations.db`
- 电脑C的数据库：`E:\项目\Safety-Manager\data\databases\regulations.db`

当你在电脑A推送更新时，更新通知只写入了电脑A的本地数据库，电脑B和C无法看到。

## 解决方案

### 方案1：使用共享网络数据库（推荐）

**原理：** 所有电脑使用同一个数据库文件

**步骤：**

1. **在网络共享位置放置数据库**
   ```
   \\公司服务器\共享文件夹\SafetyManager\data\databases\regulations.db
   ```

2. **修改每台电脑的配置**

   编辑 `shared/config.py` 文件：
   ```python
   # 原来的配置（本地路径）
   SQLITE_DB_PATH: Path = DATABASES_DIR / "regulations.db"

   # 改为网络共享路径
   SQLITE_DB_PATH: Path = Path(r"\\服务器IP\共享文件夹\SafetyManager\data\databases\regulations.db")
   ```

3. **或者使用 .env 文件配置**

   创建 `.env` 文件：
   ```
   DATABASE_PATH=\\192.168.1.100\shared\SafetyManager\regulations.db
   ```

   修改 `shared/config.py`：
   ```python
   SQLITE_DB_PATH: Path = Field(
       default=DATABASES_DIR / "regulations.db",
       env="DATABASE_PATH"
   )
   ```

**优点：**
- ✅ 实时同步，所有人看到相同数据
- ✅ 推送更新立即生效
- ✅ 无需额外服务器软件

**缺点：**
- ⚠️ 需要网络连接
- ⚠️ 多人同时编辑可能冲突
- ⚠️ 网络中断无法使用

---

### 方案2：定期同步数据库文件（简单）

**原理：** 手动或自动复制数据库文件到其他电脑

**步骤：**

1. **主电脑（管理员）推送更新后**

   复制数据库文件：
   ```
   从: D:\work_file\AI\Safety-Manager\data\databases\regulations.db
   到: \\共享文件夹\regulations_latest.db
   ```

2. **其他电脑定期更新**

   创建同步脚本 `sync_database.bat`：
   ```batch
   @echo off
   echo 正在同步数据库...
   copy /Y "\\共享文件夹\regulations_latest.db" "data\databases\regulations.db"
   echo 同步完成！
   pause
   ```

3. **或者在程序中添加同步功能**

   添加"从服务器同步"按钮，点击后自动下载最新数据库。

**优点：**
- ✅ 简单易懂
- ✅ 不需要修改代码
- ✅ 离线也能工作

**缺点：**
- ⚠️ 不是实时同步
- ⚠️ 需要手动操作
- ⚠️ 可能覆盖本地更改

---

### 方案3：使用PostgreSQL网络数据库（专业）

**原理：** 部署真正的数据库服务器

**步骤：**

1. **在服务器上安装PostgreSQL**

2. **修改配置使用PostgreSQL**

   `.env` 文件：
   ```
   POSTGRES_HOST=192.168.1.100
   POSTGRES_PORT=5432
   POSTGRES_USER=safety_admin
   POSTGRES_PASSWORD=your_password
   POSTGRES_DB=safety_manager
   OFFLINE_MODE=false
   ```

3. **修改代码使用PostgreSQL连接**

   在 `client/models/database.py` 中添加逻辑切换到 PostgreSQL。

**优点：**
- ✅ 专业级解决方案
- ✅ 支持大量并发用户
- ✅ 数据安全性高
- ✅ 真正的多用户协作

**缺点：**
- ⚠️ 需要专业部署和维护
- ⚠️ 需要修改代码
- ⚠️ 复杂度高

---

### 方案4：导出/导入更新通知（临时方案）

**原理：** 手动导出更新通知到文件，其他电脑导入

**步骤：**

1. **管理员推送更新后导出**
   ```sql
   -- 导出最新的更新通知
   SELECT * FROM update_notifications WHERE created_at > '2024-01-01';
   ```

2. **其他用户导入更新文件**

   提供导入功能，将更新通知插入本地数据库。

**优点：**
- ✅ 不需要网络
- ✅ 可以选择性导入

**缺点：**
- ⚠️ 完全手动
- ⚠️ 效率低

---

## 推荐方案选择指南

### 小团队（5人以内）- 推荐方案1
- 使用网络共享数据库
- 简单直接，无需额外配置

### 中型团队（5-20人）- 推荐方案1或方案3
- 方案1：如果网络稳定
- 方案3：如果需要更好的性能和稳定性

### 大型团队（20人以上）- 推荐方案3
- 必须使用PostgreSQL
- 考虑部署专门的服务器

### 临时使用 - 推荐方案2
- 定期手动同步
- 适合不频繁更新的场景

---

## 快速实施（方案1 - 共享数据库）

### 1. 设置共享文件夹

在一台服务器或电脑上创建共享文件夹：
```
\\192.168.1.100\SafetyManager\data\databases\
```

确保所有用户有读写权限。

### 2. 放置数据库文件

将管理员电脑的数据库复制到共享位置：
```batch
copy "D:\work_file\AI\Safety-Manager\data\databases\regulations.db" ^
     "\\192.168.1.100\SafetyManager\data\databases\regulations.db"
```

### 3. 配置所有客户端

**方法A：修改 config.py（所有人统一）**

编辑 `shared/config.py`，找到：
```python
SQLITE_DB_PATH: Path = DATABASES_DIR / "regulations.db"
```

改为：
```python
# 使用网络共享数据库
SQLITE_DB_PATH: Path = Path(r"\\192.168.1.100\SafetyManager\data\databases\regulations.db")
```

**方法B：使用 .env 文件（每人单独配置）**

每台电脑的项目根目录创建 `.env` 文件：
```
DATABASE_PATH=\\192.168.1.100\SafetyManager\data\databases\regulations.db
```

然后修改 `shared/config.py`：
```python
SQLITE_DB_PATH: Path = Field(
    default=DATABASES_DIR / "regulations.db",
    env="DATABASE_PATH"
)
```

### 4. 测试

1. 在一台电脑上推送更新
2. 在另一台电脑上点击"版本更新"按钮
3. 应该能看到刚推送的更新

---

## 注意事项

### SQLite 并发限制

SQLite 对并发写入支持有限：
- ✅ 多人同时读取：没问题
- ⚠️ 多人同时写入：可能出错

**建议：**
- 同一时间只有一个人编辑法规
- 或者升级到 PostgreSQL（方案3）

### 网络共享权限

确保：
- 所有用户对共享文件夹有读写权限
- 防火墙允许文件共享
- 网络稳定，延迟低

### 数据备份

使用共享数据库后，务必定期备份：
```batch
REM 每天自动备份
copy "\\192.168.1.100\SafetyManager\data\databases\regulations.db" ^
     "D:\Backup\regulations_%date:~0,10%.db"
```

---

## 故障排查

### 问题：无法访问网络路径
- 检查网络连接
- 检查共享文件夹权限
- ping 服务器IP确认连通

### 问题：数据库被锁定
- 关闭所有客户端程序
- 重启程序
- 考虑升级到PostgreSQL

### 问题：推送更新后其他人还是看不到
- 确认所有人使用相同的数据库路径
- 检查 `.env` 文件配置
- 让其他人点击"刷新"按钮

---

## 未来改进

计划在后续版本中添加：
- ✨ 自动数据库同步功能
- ✨ 内置服务器模式
- ✨ WebSocket 实时推送
- ✨ 冲突解决机制

---

## 获取帮助

如果遇到问题，请提供：
1. 使用的方案编号
2. 详细的错误信息
3. 网络拓扑结构
4. 用户数量
