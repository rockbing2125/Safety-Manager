# 网络数据库配置说明 ⚠️

## 当前配置状态

你的系统已配置为使用**网络共享数据库**：

```
.env 文件配置：
DATABASE_PATH=\\10.0.104.252\SafetyManager\regulations.db
```

这意味着：
- ✅ 启动程序.pyw 使用网络数据库
- ❌ build.bat 打包使用本地数据库

## 问题原因

### 你遇到的问题流程

```
1. 运行"启动程序.pyw"
   ↓
   读取 .env 配置，连接到网络数据库
   ↓
2. 编辑、新增法规
   ↓
   数据保存到：\\10.0.104.252\SafetyManager\regulations.db
   ↓
3. 运行 build.bat 打包
   ↓
   打包脚本复制：data\databases\regulations.db（本地旧数据库）
   ↓
4. 结果：打包程序中没有新法规 ❌
```

### 为什么会这样？

- **启动程序.pyw** 读取 `.env` 配置，使用网络数据库
- **build.bat** 不读取 `.env`，直接使用本地数据库
- **两个是不同的数据库文件！**

## 解决方案

### 方案1：使用增强的 build.bat（推荐）✅

**build.bat 已集成自动同步功能！** 只需直接运行打包：

```batch
1. 确保网络连接正常，能访问 \\10.0.104.252
2. 直接运行 build.bat
3. build.bat 会自动：
   - 检测网络数据库配置
   - 对比网络和本地数据库差异
   - 显示法规数量对比
   - 提供三个选项：
     [S] 同步网络数据库到本地后打包（推荐）
     [C] 继续使用当前本地数据库打包
     [N] 取消打包
4. 选择 [S] 自动同步并继续打包
5. 完成！✅
```

**无需手动运行同步脚本！** build.bat 会处理所有事情。

### 方案2：移除网络数据库配置

如果不需要多用户共享，可以改为本地数据库：

**步骤：**

1. **备份网络数据库**（如果需要）
   ```batch
   运行"数据库管理工具.bat"
   选择"4. 从网络数据库同步到本地"
   ```

2. **修改 .env 文件**
   - 打开 `.env` 文件
   - 删除或注释掉 `DATABASE_PATH` 这行：
   ```
   # DATABASE_PATH=\\10.0.104.252\SafetyManager\regulations.db
   ```

3. **验证配置**
   ```batch
   python -c "from shared.config import settings; print(settings.SQLITE_DB_PATH)"
   # 应该显示：D:\work_file\AI\Safety-Manager\data\databases\regulations.db
   ```

4. **正常使用**
   - 启动程序.pyw 现在使用本地数据库
   - 打包时自动包含最新数据

### 方案3：为打包程序配置网络数据库

如果需要分发的程序也使用网络共享数据库：

**特点：**
- 所有用户共享同一个数据库
- 需要网络连接才能运行
- 适合团队协作

**步骤：**

1. 打包时会自动包含 `.env.dist` 模板
2. 用户需要手动创建 `.env` 并配置网络路径
3. 或者在打包前修改 `.env.dist`，添加默认配置

## 新增的工具

### 1. 同步数据库.bat

专用于从网络同步到本地：

```
功能：
- 检测 .env 中的网络数据库配置
- 验证网络连接
- 对比数据库信息
- 同步到本地（自动备份）
```

### 2. 增强的数据库管理工具.bat

新增功能：
- **选项4**: 从网络数据库同步到本地
- **选项7**: 对比网络和本地数据库差异
- 自动显示网络数据库配置状态

### 3. 增强的 build.bat（已集成同步）

全自动处理：
- ✅ 读取 .env 配置
- ✅ 检测网络数据库配置
- ✅ 对比网络和本地数据库（大小、修改时间、法规数量）
- ✅ **一键同步网络数据库到本地**（自动备份）
- ✅ 三个选项：同步后打包 / 使用本地打包 / 取消
- ✅ 网络不可访问时智能处理

## 推荐的工作流程

### 情况A：开发环境（你的电脑）

```
编辑法规流程：
1. 确保网络连接正常
2. 运行"启动程序.pyw"
3. 编辑法规（保存到网络数据库）
4. 关闭程序

打包流程（超简单！）：
1. 直接运行"build.bat"
2. build.bat 自动检测网络配置
3. 显示数据库对比信息
4. 选择 [S] 同步并打包
5. 自动完成同步和打包 ✅
6. 测试打包程序
7. 分发

（无需手动同步！build.bat 已集成所有功能）
```

### 情况B：离线环境

如果经常离线工作，建议：

1. 移除网络数据库配置（方案2）
2. 使用本地数据库
3. 需要时手动同步网络数据库

## 常见问题

### Q1: 为什么要用网络数据库？

A: 网络数据库的优点：
- ✅ 多人协作，数据实时同步
- ✅ 统一管理，避免数据分散
- ✅ 自动备份（如果服务器有备份）

缺点：
- ❌ 依赖网络连接
- ❌ 访问速度可能较慢
- ❌ 打包前需要额外同步步骤

### Q2: 网络数据库不可访问怎么办？

A: 几种情况：

1. **临时网络问题**
   - 检查网络连接
   - 尝试访问 `\\10.0.104.252`
   - 联系网络管理员

2. **需要离线工作**
   - 运行"数据库管理工具.bat"
   - 选择"从网络数据库同步到本地"（在有网络时）
   - 临时注释掉 .env 中的 DATABASE_PATH
   - 使用本地数据库工作
   - 有网络后再同步回去

3. **永久改为本地**
   - 按方案2操作

### Q3: 如何在网络和本地数据库之间切换？

A: 修改 `.env` 文件：

**使用网络数据库：**
```
DATABASE_PATH=\\10.0.104.252\SafetyManager\regulations.db
```

**使用本地数据库：**
```
# DATABASE_PATH=\\10.0.104.252\SafetyManager\regulations.db
```
（注释掉或删除这行）

### Q4: 多人编辑会冲突吗？

A: SQLite 数据库的并发限制：
- ✅ 多人同时读取：没问题
- ⚠️ 多人同时写入：可能锁定等待
- ❌ 大量并发写入：不适合

建议：
- 小团队（2-5人）可以使用
- 避免同时编辑同一法规
- 频繁编辑建议升级到 PostgreSQL

### Q5: 打包后的程序能用网络数据库吗？

A: 可以！但需要配置：

1. 用户需要创建 `.env` 文件
2. 配置 `DATABASE_PATH`
3. 确保有网络访问权限

或者在打包前修改 `.env.dist` 包含默认配置。

## 快速诊断检查清单

### 打包前检查 ✓

```
1. [ ] 网络连接正常
2. [ ] 可以访问 \\10.0.104.252\SafetyManager
3. [ ] 已运行"同步数据库.bat"
4. [ ] 本地数据库已更新到最新
5. [ ] 运行 build.bat 并阅读所有提示
```

### 问题诊断 ✓

**症状：打包后没有新法规**

检查：
```batch
1. 查看 .env 是否配置了 DATABASE_PATH
   - 是 → 需要同步网络数据库
   - 否 → 检查是否在正确的环境编辑

2. 运行"数据库管理工具.bat"
   - 选择"5. 查看所有数据库文件信息"
   - 对比修改时间

3. 运行"数据库管理工具.bat"
   - 选择"7. 对比网络和本地数据库差异"
   - 查看法规数量差异
```

## 总结

### 你当前的问题

❌ **问题**：在启动程序.pyw中编辑法规，打包后没有同步

✅ **原因**：.env配置了网络数据库，启动程序使用网络数据库，build.bat使用本地数据库

✅ **解决**：直接运行 build.bat，选择 [S] 自动同步并打包

### 最简单的正确流程

```
编辑法规（启动程序.pyw）
   ↓
关闭程序
   ↓
运行 build.bat  ← 只需要这一步！
   ↓
build.bat 自动检测网络数据库配置
   ↓
显示对比信息（法规数量、大小、时间）
   ↓
选择 [S] 同步网络数据库到本地后打包
   ↓
自动同步（自动备份）+ 自动打包
   ↓
打包成功 ✅
```

**只需运行一个脚本，build.bat 会处理所有事情！**

---

**重要提醒：**

> ✅ build.bat 已集成自动同步功能，直接运行即可！
> ✅ 检测到网络配置时，选择 [S] 自动同步并打包
> ✅ 自动备份本地数据库，安全可靠
> ✅ 显示详细对比信息（法规数量、大小、时间），一目了然
