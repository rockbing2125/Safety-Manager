# 数据库使用和打包说明 ⚠️

## 重要概念：开发环境 vs 打包环境

### 开发环境
- **位置**: `data\databases\regulations.db`
- **用途**: 日常开发和编辑法规数据
- **启动方式**: 运行 `启动程序.pyw`
- **特点**: 这是**源数据库**，打包时会复制这个数据库

### 打包环境
- **位置**: `dist\SafetyManager\data\databases\regulations.db`
- **用途**: 测试打包后的程序
- **启动方式**: 运行 `dist\SafetyManager\SafetyManager.exe`
- **特点**: 这是**临时副本**，重新打包时会被删除

## ⚠️ 常见的数据丢失场景

### 场景1：在打包程序中编辑数据（导致数据丢失）❌

```
1. 运行 build.bat 打包程序
2. 运行 dist\SafetyManager\SafetyManager.exe
3. 在打包程序中编辑、新增法规  ← 数据保存在 dist 目录
4. 再次运行 build.bat
5. build.bat 清空 dist 目录  ← ⚠️ 你的编辑内容丢失了！
```

### 场景2：正确的工作流程 ✅

```
1. 运行 启动程序.pyw（开发环境）
2. 编辑、新增法规  ← 数据保存在 data\databases\regulations.db
3. 关闭程序
4. 运行 build.bat 打包  ← 打包时会复制最新的开发数据库
5. 打包完成，新法规已包含在内 ✅
```

## 正确的使用流程

### 日常编辑法规

1. **始终使用开发环境**: 双击 `启动程序.pyw`
2. 编辑、新增、修改法规
3. 保存并退出程序
4. 数据会自动保存到 `data\databases\regulations.db`

### 打包分发程序

1. **确保已在开发环境中编辑**: 检查 `data\databases\regulations.db` 的修改时间
2. **运行打包脚本**: 双击 `build.bat`
3. **注意打包脚本的警告**: 如果有 dist 目录数据库的警告，请仔细阅读
4. **测试打包程序**: 运行 `dist\SafetyManager\SafetyManager.exe` 验证法规是否正确
5. **分发**: 压缩 `dist\SafetyManager\` 文件夹进行分发

## 数据保护机制

### 自动保护（build.bat）

打包脚本现在包含数据保护机制：

- ✅ 在清空 dist 目录前自动检测数据库文件
- ✅ 对比开发环境和 dist 环境的数据库
- ✅ 自动备份 dist 目录的数据库到 `backup\` 文件夹
- ✅ 询问是否继续打包，防止意外删除数据

### 手动工具（数据库管理工具.bat）

提供了专门的数据库管理工具，可以：

1. **备份开发环境数据库**: 手动创建备份
2. **从备份恢复**: 恢复到之前的状态
3. **从 dist 恢复**: 如果误在打包程序中编辑，可以恢复回来
4. **查看数据库信息**: 对比各个数据库的大小和修改时间
5. **查看备份列表**: 查看所有历史备份

## 数据恢复指南

### 情况1：刚运行完 build.bat，发现数据丢失

如果你刚运行完 build.bat 并且它显示了警告：

1. **检查备份文件夹**: `backup\` 目录中应该有自动备份
2. **运行数据库管理工具**: 双击 `数据库管理工具.bat`
3. **选择"从备份恢复"**: 选择最新的备份文件
4. **重新打包**: 再次运行 `build.bat`

### 情况2：在 dist 程序中编辑了数据，但还没运行 build.bat

**立即停止！不要运行 build.bat！**

1. **运行数据库管理工具**: 双击 `数据库管理工具.bat`
2. **选择"从 dist 目录恢复数据库"**
3. **确认恢复**: 这会把 dist 目录的数据库复制到开发环境
4. **之后正常打包**: 现在可以安全地运行 `build.bat` 了

### 情况3：数据已经丢失，没有备份

很遗憾，如果 dist 目录已被清空且没有备份，数据无法恢复。

**预防措施**：
- 定期使用"数据库管理工具"手动备份
- 始终在开发环境（启动程序.pyw）中编辑数据
- 打包前检查数据库修改时间

## 快速检查清单

### 打包前检查 ✓

```bash
1. [ ] 我是在"启动程序.pyw"中编辑的法规（不是 dist 程序）
2. [ ] 我已关闭了所有程序实例
3. [ ] data\databases\regulations.db 的修改时间是最新的
4. [ ] 我已阅读 build.bat 的所有警告信息
5. [ ] 如有必要，我已手动备份数据库
```

### 日常编辑检查 ✓

```bash
1. [ ] 我运行的是"启动程序.pyw"（不是 dist 中的 exe）
2. [ ] 程序标题栏显示的路径是正确的开发环境路径
3. [ ] 编辑完成后我正常退出了程序
```

## 常见问题

### Q: 如何判断我运行的是哪个环境？

A: 查看程序窗口：
- 开发环境：通过 Python 启动，可能有控制台窗口
- 打包环境：直接运行 .exe，位于 dist 目录

### Q: 可以在打包程序中测试吗？

A: 可以测试，但**不要进行数据编辑**！
- ✅ 可以：查看法规、搜索、测试功能
- ❌ 不要：新增、编辑、删除法规

如果需要编辑，请切换到开发环境（启动程序.pyw）。

### Q: 打包后的程序可以给用户编辑吗？

A: 可以！用户在打包程序中的编辑是安全的，因为：
- 用户的数据在他们自己的电脑上
- 他们不会运行 build.bat
- 这就是打包程序的正常用途

**这个限制只针对开发者（你）** —— 不要在开发机器的 dist 目录程序中编辑数据。

### Q: 为什么不让打包程序读写开发数据库？

A: 这是有意设计的隔离：
- 开发环境和打包环境使用独立的数据库
- 防止打包程序意外污染开发数据
- 确保打包前数据的一致性

## 建议的工作习惯

1. **专用编辑环境**: 始终在 `启动程序.pyw` 中编辑
2. **定期备份**: 重要修改前使用"数据库管理工具"备份
3. **打包前验证**: 检查 `data\databases\regulations.db` 修改时间
4. **阅读警告**: 认真阅读 build.bat 显示的所有警告信息
5. **测试独立**: 在虚拟机或其他电脑上测试打包程序

## 技术细节

### 打包时的数据库处理

`build.bat` 和 `SafetyManager.spec` 的工作流程：

1. **打包前**: 读取 `data\databases\regulations.db`
2. **打包时**:
   - 复制到 `dist\SafetyManager\_internal\data\databases\`（打包资源）
   - 复制到 `dist\SafetyManager\data\databases\`（用户数据）
3. **运行时**:
   - 首次运行：从 `_internal` 复制到用户目录
   - 之后运行：使用用户目录的数据库

### 为什么会有两个数据库副本？

- `_internal\data\databases\regulations.db`: 只读模板，内置在程序中
- `data\databases\regulations.db`: 可写副本，用户实际使用

这样设计是为了：
- 保护原始数据不被意外修改
- 允许用户数据独立更新
- 支持程序重置功能（恢复到初始状态）

---

**记住最重要的一点**：

> ⚠️ 永远在开发环境（启动程序.pyw）中编辑法规数据！
> ⚠️ dist 目录是临时的，随时可能被清空！
> ⚠️ 打包前仔细阅读所有警告信息！
