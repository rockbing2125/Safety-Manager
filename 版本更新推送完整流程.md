# 版本更新推送完整流程

## 概述

本文档详细说明如何推送新版本更新，让所有用户的程序自动收到更新通知。

---

## 快速流程（5步骤）

```
1. 修改代码 → 2. 打包程序 → 3. 发布 Release → 4. 更新 version.json → 5. 推送到 GitHub
```

用户程序会在 **1-2分钟后** 自动检测到新版本。

---

## 详细步骤

### 第一步：开发新版本

#### 1.1 更新代码

完成你的功能开发、bug 修复或性能优化。

#### 1.2 更新版本号

编辑 `shared/config.py`，找到第 41 行：

```python
APP_VERSION: str = "1.0.0"  # 修改为新版本号
```

改为：

```python
APP_VERSION: str = "1.1.0"  # 例如：新功能
# 或
APP_VERSION: str = "1.0.1"  # 例如：bug 修复
```

**版本号规则**：
- **主版本号**（X.0.0）：重大更新，不兼容旧版本
- **次版本号**（1.X.0）：新功能，向下兼容
- **修订号**（1.0.X）：bug 修复，向下兼容

#### 1.3 测试新版本

```bash
# 运行程序测试
python run.py

# 测试主要功能
# - 登录功能
# - 法规管理
# - 代码管理
# - 搜索功能
# - 其他新功能
```

确保所有功能正常工作。

---

### 第二步：打包新版本

#### 2.1 运行打包脚本

```bash
build.bat
```

等待打包完成（需要几分钟）。

#### 2.2 测试打包结果

```bash
# 运行打包后的程序
dist\SafetyManager\SafetyManager.exe
```

确认：
- ✅ 程序能正常启动
- ✅ 版本号正确显示
- ✅ 所有功能正常

#### 2.3 创建分发包

压缩 `dist\SafetyManager\` 文件夹：

```bash
# 方式一：Windows 资源管理器
# 右键 dist\SafetyManager 文件夹 → 发送到 → 压缩(zipped)文件夹
# 重命名为：SafetyManager_v1.1.0.zip

# 方式二：PowerShell
cd dist
Compress-Archive -Path SafetyManager -DestinationPath SafetyManager_v1.1.0.zip
```

---

### 第三步：发布 GitHub Release

#### 3.1 访问 Releases 页面

在浏览器中打开：
```
https://github.com/rockbing2125/Safety-Manager/releases
```

#### 3.2 创建新的 Release

点击 **"Draft a new release"** 或 **"Create a new release"**

#### 3.3 填写 Release 信息

**Tag version**（标签）:
```
v1.1.0
```
**重要**：必须以 `v` 开头

**Release title**（标题）:
```
Safety Manager v1.1.0 - [更新主题]
```

例如：
- `Safety Manager v1.1.0 - 新增导出功能`
- `Safety Manager v1.0.1 - 修复搜索bug`

**Describe this release**（描述）:

```markdown
## Safety Manager v1.1.0

### ✨ 新增功能

- 新增 Excel 导出功能
- 新增批量导入法规文档
- 新增搜索结果高亮显示

### 🐛 Bug 修复

- 修复搜索关键词为空时的崩溃问题
- 修复法规删除后刷新不及时的问题

### ⚡ 性能优化

- 优化大文件加载速度
- 优化数据库查询性能

### 📝 其他更新

- 更新用户界面样式
- 完善错误提示信息

---

### 📦 安装说明

**新用户**：
1. 下载 `SafetyManager_v1.1.0.zip`
2. 解压到任意位置
3. 运行 `SafetyManager.exe`

**已有用户**：
1. 下载新版本
2. 关闭旧程序
3. 解压并覆盖安装
4. 数据会自动保留

**自动更新**：
- 程序会自动检测此更新
- 启动时弹窗提醒
- 点击通知中的链接下载

---

### ⚠️ 重要提示

- **建议备份**：更新前请备份 `data` 文件夹
- **兼容性**：完全兼容 v1.0.x 版本的数据
- **系统要求**：Windows 10 或更高版本

---

### 🔗 相关链接

- 完整更新日志: [CHANGELOG.md](../CHANGELOG.md)
- 使用文档: [README.md](../README.md)
- 问题反馈: [Issues](https://github.com/rockbing2125/Safety-Manager/issues)
```

#### 3.4 上传分发包

1. 在 **"Attach binaries"** 区域点击上传文件
2. 选择 `SafetyManager_v1.1.0.zip`
3. 等待上传完成

#### 3.5 发布 Release

1. 检查所有信息无误
2. 点击 **"Publish release"** 按钮
3. Release 发布成功！

#### 3.6 获取下载链接

发布后，右键点击 zip 文件，选择 **"复制链接地址"**，得到类似：

```
https://github.com/rockbing2125/Safety-Manager/releases/download/v1.1.0/SafetyManager_v1.1.0.zip
```

复制这个链接，下一步会用到。

---

### 第四步：更新 version.json

#### 4.1 编辑 version.json

回到项目根目录，编辑 `version.json` 文件：

```json
{
  "version": "1.1.0",
  "release_date": "2025-12-05",
  "download_url": "https://github.com/rockbing2125/Safety-Manager/releases/download/v1.1.0/SafetyManager_v1.1.0.zip",
  "changelog": [
    "✨ 新增 Excel 导出功能",
    "✨ 新增批量导入法规文档",
    "✨ 新增搜索结果高亮显示",
    "🐛 修复搜索关键词为空时的崩溃问题",
    "⚡ 优化大文件加载速度"
  ],
  "required": false,
  "min_version": "1.0.0"
}
```

**字段说明**：

| 字段 | 说明 | 必填 |
|------|------|------|
| `version` | 新版本号，必须大于当前版本 | 是 |
| `release_date` | 发布日期（YYYY-MM-DD格式） | 是 |
| `download_url` | 从 Release 复制的下载链接 | 是 |
| `changelog` | 更新日志，数组格式 | 是 |
| `required` | 是否强制更新（true/false） | 否 |
| `min_version` | 支持的最低版本 | 否 |

**注意事项**：
- ✅ `version` 必须大于旧版本（如 1.1.0 > 1.0.0）
- ✅ `download_url` 使用从 Release 复制的完整链接
- ✅ `changelog` 使用数组格式，每条更新一个元素
- ✅ 可以使用 Emoji 让更新日志更直观

**Emoji 参考**：
- ✨ 新功能
- 🐛 Bug 修复
- ⚡ 性能优化
- 🎨 UI 改进
- 📝 文档更新
- 🔒 安全更新
- 🔧 配置更改

#### 4.2 验证 JSON 格式

确保 JSON 格式正确，可以使用在线工具验证：
- https://jsonlint.com/

或本地验证：

```bash
python -c "import json; json.load(open('version.json')); print('JSON格式正确')"
```

---

### 第五步：推送到 GitHub

#### 5.1 提交更改

```bash
git add version.json shared/config.py
git commit -m "发布 v1.1.0 版本

主要更新：
- 新增 Excel 导出功能
- 新增批量导入法规文档
- 新增搜索结果高亮显示
- 修复搜索相关 bug
- 优化性能

Release: https://github.com/rockbing2125/Safety-Manager/releases/tag/v1.1.0
"
```

#### 5.2 推送到 GitHub

```bash
git push
```

#### 5.3 等待 CDN 刷新

GitHub CDN 需要 **1-2 分钟** 更新缓存，推送后请等待。

---

### 第六步：验证更新推送

#### 6.1 测试更新检测

打开一个旧版本的程序：

```bash
# 如果你有旧版本的程序，运行它
SafetyManager.exe
```

程序应该：
1. ✅ 启动时自动检测更新
2. ✅ 显示更新通知弹窗
3. ✅ 工具栏显示小红点
4. ✅ 点击查看更新详情

#### 6.2 检查更新内容

在更新通知中应该看到：
- ✅ 新版本号（1.1.0）
- ✅ 发布日期
- ✅ 更新日志
- ✅ 下载链接可点击

#### 6.3 测试下载链接

点击下载链接，确认：
- ✅ 能正常下载
- ✅ 文件大小正确
- ✅ 解压后能正常运行

---

## 通知用户

### 方式一：程序内自动通知（推荐）

用户的程序会自动检测更新：
- **启动时**：立即检查一次
- **运行时**：每 5 分钟检查一次
- **新版本**：自动弹窗提醒

**无需手动通知**，程序会自动完成！

### 方式二：主动通知

如果需要主动通知用户：

**邮件通知模板**：

```
主题：Safety Manager v1.1.0 新版本发布

各位用户好！

Safety Manager v1.1.0 已经发布，主要更新包括：

✨ 新功能
- 新增 Excel 导出功能
- 新增批量导入法规文档
- 新增搜索结果高亮显示

🐛 Bug 修复
- 修复搜索崩溃问题
- 修复刷新不及时问题

⚡ 性能优化
- 优化大文件加载速度
- 优化数据库查询性能

【如何更新】

方式一：自动通知（推荐）
- 重启程序，会自动收到更新通知
- 点击通知中的下载链接

方式二：手动下载
- 访问：https://github.com/rockbing2125/Safety-Manager/releases/tag/v1.1.0
- 下载并覆盖安装

【重要提示】
- 更新前请备份 data 文件夹
- 完全兼容旧版本数据
- 有问题请及时反馈

感谢使用！
```

**企业通讯工具**：

```
【新版本】Safety Manager v1.1.0 🎉

主要更新：
✨ 新增导出、批量导入、搜索高亮功能
🐛 修复多个 bug
⚡ 性能大幅优化

更新方式：
重启程序即可收到更新通知

下载地址：
https://github.com/rockbing2125/Safety-Manager/releases/tag/v1.1.0

有问题随时反馈！
```

---

## 高级功能

### 强制更新

如果发现严重 bug，需要强制用户更新：

在 `version.json` 中设置：

```json
{
  "version": "1.1.1",
  "required": true,    // 设置为 true 表示强制更新
  "min_version": "1.0.0",
  ...
}
```

程序会：
- ❌ 阻止用户继续使用旧版本
- ✅ 强制显示更新提醒
- ✅ 提示必须更新才能使用

### 版本兼容性检查

如果新版本不兼容某些旧版本：

```json
{
  "version": "2.0.0",
  "min_version": "1.5.0",   // 只支持 1.5.0 及以上版本升级
  ...
}
```

用户如果是 1.4.x 或更早版本：
- ⚠️ 会收到提示：需要先升级到 1.5.0
- ⚠️ 提供过渡版本下载链接

### 灰度发布（金丝雀部署）

如果担心新版本有问题，可以分阶段发布：

**第一阶段：测试用户**

1. 创建测试 Release（`v1.1.0-beta`）
2. 发给少量测试用户
3. 收集反馈

**第二阶段：小范围发布**

1. 发布正式版（`v1.1.0`）
2. 先不更新 `version.json`
3. 让一部分用户手动下载测试

**第三阶段：全量发布**

1. 确认没问题后
2. 更新 `version.json`
3. 推送到 GitHub
4. 所有用户收到更新

---

## 常见问题

### Q1: 用户没有收到更新通知？

**可能原因**：
1. GitHub CDN 缓存未刷新（等待 2-5 分钟）
2. 用户程序未重启（需要重启或等待 5 分钟）
3. 网络问题（无法访问 GitHub）
4. version.json 格式错误

**解决方法**：
```bash
# 1. 检查 version.json 是否已推送
git log -1 version.json

# 2. 测试 GitHub Raw 链接
curl https://raw.githubusercontent.com/rockbing2125/Safety-Manager/main/version.json

# 3. 检查 JSON 格式
python -c "import json; print(json.load(open('version.json')))"

# 4. 查看程序日志
type data\logs\app_main.log
```

### Q2: 版本号比较错误？

**问题**：1.10.0 被认为小于 1.2.0

**原因**：版本号比较逻辑问题

**解决**：使用标准的语义化版本号
- ✅ 1.2.0 → 1.3.0 → 1.10.0（正确）
- ❌ 1.2 → 1.3 → 1.10（可能出错）

项目已使用 `packaging.version` 正确处理版本比较。

### Q3: 下载链接失效？

**可能原因**：
1. Release 删除或改名
2. 文件名不匹配
3. GitHub 访问限制

**解决方法**：
1. 确认 Release 存在
2. 检查文件名拼写
3. 测试链接是否可访问
4. 考虑使用备用下载地址

### Q4: 如何回滚版本？

**场景**：发布后发现严重 bug

**步骤**：

1. 在 GitHub 找到旧版本 Release
2. 复制旧版本的下载链接
3. 修改 `version.json` 回到旧版本号（但通常不建议）

**推荐方式**：
```json
{
  "version": "1.1.1",  // 发布新的修复版本
  "changelog": [
    "🐛 紧急修复 v1.1.0 的严重bug",
    "建议所有 v1.1.0 用户立即更新"
  ],
  "required": true     // 强制更新
}
```

### Q5: 能否支持差量更新？

**当前**：需要下载完整安装包

**未来**：可以实现差量更新：
1. 只下载变更的文件
2. 自动应用补丁
3. 大幅减少下载大小

需要修改更新逻辑和打包方式。

---

## 更新检查清单

发布新版本前请检查：

- [ ] 代码已全面测试
- [ ] 版本号已更新（shared/config.py）
- [ ] 打包文件已测试
- [ ] GitHub Release 已创建
- [ ] 分发包已上传
- [ ] version.json 已更新
  - [ ] version 正确
  - [ ] download_url 正确
  - [ ] changelog 完整
  - [ ] 日期正确
- [ ] version.json 已推送到 GitHub
- [ ] 等待 2 分钟 CDN 刷新
- [ ] 测试更新检测功能
- [ ] 通知用户（如需要）

---

## 版本发布时间表建议

### 定期发布

**月度发布**（推荐）：
- 每月固定时间发布
- 包含新功能和 bug 修复
- 用户可以预期更新时间

**季度发布**：
- 适合稳定的企业应用
- 包含重大功能更新
- 减少用户升级频率

### 紧急发布

**安全更新**：
- 立即发布
- 强制更新
- 详细说明风险

**严重 Bug**：
- 尽快发布修复版本
- 建议强制更新
- 提供回滚方案

---

## 相关文档

- **软件分发**: 《软件分发完整指南.md》
- **GitHub 配置**: 《GitHub版本更新配置指南.md》
- **快速开始**: 《GitHub版本更新快速开始.md》
- **推送功能**: 《推送功能使用说明.md》

---

## 总结

推送新版本更新的完整流程：

1. ✅ 开发新版本 → 更新版本号
2. ✅ 打包程序 → 测试运行
3. ✅ 创建 GitHub Release → 上传分发包
4. ✅ 更新 version.json → 推送到 GitHub
5. ✅ 等待 CDN 刷新 → 用户自动收到更新

整个过程只需 **15-30 分钟**，用户会在 **1-5 分钟内** 收到更新通知！

**开始推送你的更新吧！** 🚀
