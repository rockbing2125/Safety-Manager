# 数据库同步说明

## 问题描述

运行 `启动程序.pyw` (开发环境) 编辑的法规内容，在运行打包后的 `SafetyManager.exe` 中看不到。

## 原因分析

开发环境和打包后的程序使用了**不同的数据库文件**：

- **开发环境**：`D:\work_file\AI\Safety-Manager\data\databases\regulations.db`
- **打包环境**：`D:\work_file\AI\Safety-Manager\dist\SafetyManager\data\databases\regulations.db`

这是因为程序会根据运行环境自动确定数据库位置：
- 开发环境：使用项目根目录下的 data 目录
- 打包环境：使用 exe 所在目录下的 data 目录

## 解决方案

### 方案1：重新打包并同步数据库（推荐）

运行 `build.bat` 打包时，会询问是否同步开发环境数据库：

```
[可选] 同步开发环境数据库到打包目录
============================================

检测到开发环境数据库: data\databases\regulations.db
  大小: 151552 字节
  时间: 2024-12-02 10:27

是否要将开发环境的数据库复制到打包目录？(Y/N，默认N):
```

**选择 Y** 即可将开发环境的数据同步到打包程序中。

### 方案2：手动同步数据库

运行 `sync_database_to_dist.bat`，按提示操作：

```batch
同步数据库到打包目录
========================================

[源文件] data\databases\regulations.db
  大小: 151552 字节
  时间: 2024-12-02 10:27

[目标文件] dist\SafetyManager\data\databases\regulations.db
  大小: 122880 字节
  时间: 2024-12-03 15:23

是否要覆盖打包目录中的数据库？(Y/N): Y
```

### 方案3：直接复制文件

手动复制数据库文件：

```batch
# 备份旧数据库（可选）
copy dist\SafetyManager\data\databases\regulations.db dist\SafetyManager\data\databases\regulations.db.bak

# 复制新数据库
copy /Y data\databases\regulations.db dist\SafetyManager\data\databases\regulations.db
```

### 方案4：使用共享数据库（多用户环境）

如果需要多台电脑共享同一数据库，可以配置网络共享路径：

1. 创建 `.env` 文件（或修改现有的）
2. 添加配置：
   ```
   DATABASE_PATH=\\192.168.1.100\SafetyManager\regulations.db
   ```
3. 将数据库文件放到共享文件夹
4. 重新打包或直接在打包目录中添加 `.env` 文件

这样所有电脑都会使用同一个数据库文件。

## 工作流程建议

### 开发环境编辑 → 打包分发

如果您在开发环境编辑数据，然后需要分发给其他用户：

1. 在开发环境编辑法规内容（运行 `启动程序.pyw`）
2. 运行 `build.bat` 重新打包
3. 打包完成时选择 **Y** 同步数据库
4. 将 `dist\SafetyManager\` 文件夹压缩成 zip
5. 分发给用户

### 测试打包程序

如果只是想测试打包程序，有两种选择：

**选项A：同步数据库**
```batch
# 先同步数据库
sync_database_to_dist.bat

# 然后运行
dist\SafetyManager\SafetyManager.exe
```

**选项B：在打包程序中重新输入数据**
- 直接运行 `dist\SafetyManager\SafetyManager.exe`
- 在打包程序中重新添加法规内容
- 这样可以测试打包程序的完整功能

## 验证数据库同步

同步后可以检查文件大小和时间：

```batch
# 查看开发环境数据库
dir data\databases\regulations.db

# 查看打包环境数据库
dir dist\SafetyManager\data\databases\regulations.db
```

如果两个文件的大小和时间一致，说明同步成功。

## 常见问题

### Q: 为什么不默认使用同一个数据库？

A: 这是有意设计的：
- **开发环境**：用于开发测试，可以随意修改
- **打包环境**：用于用户分发，应该是独立的
- 如果需要共享，可以使用网络共享数据库（方案4）

### Q: 每次打包都要同步数据库吗？

A: 看情况：
- 如果开发环境有新数据 → **需要同步**
- 如果只是修改代码 → **不需要同步**
- 分发给用户时 → **通常需要同步**

### Q: 图片文件也需要同步吗？

A: 是的！参数中的图片存储在 `data/parameter_images/` 目录，打包时会自动包含。但如果在开发环境添加了新图片，需要重新打包。

## 技术细节

数据库路径由 `shared/config.py` 中的 `get_base_dir()` 函数决定：

```python
def get_base_dir() -> Path:
    """获取程序根目录（支持打包后的环境）"""
    if getattr(sys, 'frozen', False):
        # 打包后的环境：使用可执行文件所在目录
        return Path(sys.executable).parent
    else:
        # 开发环境：使用项目根目录
        return Path(__file__).resolve().parent.parent
```

这确保了程序在不同环境下都能正确找到数据文件。
