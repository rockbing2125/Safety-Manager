# 推送功能使用说明

## 功能概述

系统现在支持**自动推送通知**功能，当管理员推送更新后，其他电脑上的用户会自动收到提醒。

## 工作原理

### 1. 通知存储
- 所有推送通知存储在共享数据库的 `update_notifications` 表中
- 每条通知包含：类型、标题、消息、是否已读、创建时间等信息

### 2. 自动检测机制
- **启动检查**：程序启动时立即检查一次未读通知
- **定时检查**：每5分钟自动检查一次
- **智能提醒**：
  - 首次打开程序时，如果有未读通知，会弹窗提醒
  - 运行期间，如果检测到新的通知（数量增加），会自动弹窗提醒

### 3. 界面提示
- **小红点**：工具栏的【版本更新】按钮上会显示未读通知数量
- **弹窗提醒**：有新通知时会自动弹出提示窗口
- **通知列表**：点击【版本更新】按钮查看所有通知详情

## 使用步骤

### 前提条件：配置共享数据库

两台电脑必须访问**同一个数据库文件**才能实现推送功能。

#### 方法1：使用配置工具（推荐）

1. 在主电脑上设置共享文件夹：
   ```
   \\10.0.104.252\SafetyManager\
   ```

2. 在每台电脑上双击运行：`配置共享数据库.bat`

3. 输入数据库完整路径：
   ```
   \\10.0.104.252\SafetyManager\regulations.db
   ```

4. 工具会自动生成正确的 `.env` 配置文件

#### 方法2：手动配置

编辑项目根目录的 `.env` 文件：

```ini
# 数据库配置
DATABASE_PATH=\\10.0.104.252\SafetyManager\regulations.db

# 其他配置保持默认
OFFLINE_MODE=True
LOG_LEVEL=INFO
```

**重要提示：**
- 路径必须包含 `regulations.db` 文件名
- 使用双反斜杠 `\\` 作为路径分隔符
- 确保共享文件夹有读写权限

### 管理员推送通知

1. 以管理员身份登录系统

2. 在主窗口工具栏点击【推送更新】按钮

3. 填写通知信息：
   - **通知类型**：选择"软件版本更新"或"法规内容更新"
   - **标题**：简短描述更新内容（必填）
   - **版本号**：软件更新时填写（可选）
   - **消息内容**：详细说明更新内容（可选）

4. 点击【推送通知】按钮

5. 推送成功后，所有用户会在下次打开程序或5分钟内收到通知

### 法规自动推送

当管理员**新增或修改法规**时，系统会自动推送通知，无需手动操作。

通知内容包括：
- 法规名称
- 法规编号
- 国家/地区
- 版本号

### 用户接收通知

#### 自动提醒
- 打开程序后，如果有未读通知，会自动弹出提示框
- 运行期间收到新通知，也会自动弹出提示

#### 查看通知
1. 注意工具栏【版本更新】按钮上的红色徽章（显示未读数量）

2. 点击【版本更新】按钮，打开通知列表

3. 查看通知详情：
   - 通知类型（软件更新 / 法规更新）
   - 标题和内容
   - 创建时间
   - 已读/未读状态

4. 操作选项：
   - **标记为已读**：单个通知标记为已读
   - **全部已读**：一键标记所有通知为已读
   - **清空所有**：删除所有通知记录

## 常见问题

### Q1: 另一台电脑收不到推送？

**可能原因：**
1. 数据库路径配置不正确
2. 网络共享权限不足
3. 两台电脑使用的不是同一个数据库

**解决方法：**
1. 检查 `.env` 文件中的 `DATABASE_PATH` 配置
2. 确保路径包含完整的文件名：`\\服务器\共享文件夹\regulations.db`
3. 运行 `测试数据库连接.bat` 验证连接是否正常
4. 确保两台电脑的 `DATABASE_PATH` 完全一致

### Q2: 如何验证数据库配置是否正确？

运行测试脚本：
```bash
python -c "from shared.config import settings; print(f'数据库路径: {settings.SQLITE_DB_PATH}')"
```

或者双击运行：`测试数据库连接.bat`

### Q3: 可以关闭自动弹窗提醒吗？

目前自动弹窗是内置功能，无法关闭。但你可以：
- 点击【全部已读】按钮，清除未读状态
- 关闭提示框后，小红点仍会显示未读数量

### Q4: 推送的通知会保留多久？

- 通知会永久保存在数据库中，除非手动清空
- 建议定期使用【清空所有】功能清理旧通知

### Q5: 多用户环境下，每个用户的已读状态是独立的吗？

**不是**。当前实现中，已读状态是全局的：
- 任何用户标记为已读，所有用户都会看到已读状态
- 这是因为通知表没有关联用户ID

如需独立的已读状态，需要修改数据库结构。

## 技术说明

### 检测机制
- 程序启动时调用 `start_update_check_timer()`
- 首次检查立即执行 `check_for_updates()`
- 创建 QTimer，每5分钟（300秒）触发一次检查
- 比较当前未读数量与上次记录，决定是否弹窗

### 相关文件
- **主窗口**：`client/ui/main_window.py` - 检测和提醒逻辑
- **通知服务**：`client/services/update_service.py` - 通知管理
- **数据模型**：`client/models/update_notification.py` - 通知表结构
- **推送对话框**：`client/ui/push_update_dialog.py` - 管理员推送界面
- **通知列表**：`client/ui/update_notifications_dialog.py` - 用户查看界面

### 数据库表结构
```sql
CREATE TABLE update_notifications (
    id INTEGER PRIMARY KEY,
    type VARCHAR(20) NOT NULL,        -- software 或 regulation
    title VARCHAR(200) NOT NULL,      -- 通知标题
    message TEXT,                     -- 详细消息
    version VARCHAR(50),              -- 版本号（软件更新时使用）
    regulation_id INTEGER,            -- 法规ID（法规更新时使用）
    is_read BOOLEAN DEFAULT FALSE,    -- 是否已读
    created_at DATETIME NOT NULL      -- 创建时间
);
```

## 最佳实践

1. **管理员**：
   - 推送重要更新时，写清楚标题和内容
   - 法规更新会自动推送，无需手动操作
   - 定期清理旧通知，保持通知列表整洁

2. **用户**：
   - 注意工具栏的小红点提示
   - 及时查看通知内容
   - 阅读后标记为已读，避免重复提醒

3. **系统管理员**：
   - 确保共享文件夹权限正确
   - 定期备份数据库文件
   - 监控网络连接稳定性

## 未来改进

可能的功能增强：
- [ ] 支持每个用户独立的已读状态
- [ ] 通知优先级（普通/重要/紧急）
- [ ] 自定义检查间隔时间
- [ ] 推送到系统托盘通知
- [ ] 邮件通知功能
- [ ] 通知历史统计
